{"name":"Server","slug":"Server","count":1,"postlist":[{"_id":"cjp28lh2l0000trnwww5xgz0y","title":"使用CDN把Shadowsocks主機的實體IP隱藏","slug":"使用CDN把SS主機的實體IP隱藏","date":"2018-11-29T11:06:02.000Z","updated":"2018-11-29T12:51:52.012Z","comments":true,"permalink":"/2018/11/29/使用CDN把SS主機的實體IP隱藏/","path":"api/articles/使用CDN把SS主機的實體IP隱藏.json","excerpt":"","keywords":null,"content":"<p>一般Shadowsocks 機場，直接到服務器的真實IP，這種VPS服務器的IP 段都是連著的，出較出名的VPS服務商的IP 段很易被掃出來，之後被各種DDOS或暴力破解。</p>\n<p>使用CDN反代就可以把IP 隱藏起來，也可以把被GFW 封了的IP 段機器再利用。別外加上Nginx 反代可以把Shadowsocks 偽裝成網站頁面，或跳轉到別的頁面。</p>\n<h3 id=\"Shadowsocks-配置\"><a href=\"#Shadowsocks-配置\" class=\"headerlink\" title=\"Shadowsocks 配置\"></a>Shadowsocks 配置</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ss-server -s 0.0.0.0 -p 8080 -c config.json --fast-open --plugin obfs-server --plugin-opts <span class=\"string\">\"obfs=http\"</span></span><br></pre></td></tr></table></figure>\n<p>Ps: obfs使用 http 不要使用 tls，因為CDN 的https會做了別一重的tls封裝，引致解密失敗。</p>\n<blockquote>\n<p>Cloudflare 支持直接的端口</p>\n</blockquote>\n<p><code>80, 8080, 8880, 2052, 2082, 2086, 2095</code></p>\n<p><del>如果使用 Cloudflare 強制 https/tls, 可以在page rules 把需使用的域名加入例外規則。</del></p>\n<p>在 Cloudflare 上需要在 Crypto 關閉 Always Use HTTPS，不然 http 流量會強制跳到 https</p>\n<p>如果使用Nginx 作為反代過濾，可以把非 SS連接跳轉到別的頁面</p>\n<h3 id=\"Nginx-配置\"><a href=\"#Nginx-配置\" class=\"headerlink\" title=\"Nginx 配置\"></a>Nginx 配置</h3><figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br><span class=\"line\" data-line-number=\"2\"></span><br><span class=\"line\" data-line-number=\"3\"></span><br><span class=\"line\" data-line-number=\"4\"></span><br><span class=\"line\" data-line-number=\"5\"></span><br><span class=\"line\" data-line-number=\"6\"></span><br><span class=\"line\" data-line-number=\"7\"></span><br><span class=\"line\" data-line-number=\"8\"></span><br><span class=\"line\" data-line-number=\"9\"></span><br><span class=\"line\" data-line-number=\"10\"></span><br><span class=\"line\" data-line-number=\"11\"></span><br><span class=\"line\" data-line-number=\"12\"></span><br><span class=\"line\" data-line-number=\"13\"></span><br><span class=\"line\" data-line-number=\"14\"></span><br><span class=\"line\" data-line-number=\"15\"></span><br><span class=\"line\" data-line-number=\"16\"></span><br><span class=\"line\" data-line-number=\"17\"></span><br><span class=\"line\" data-line-number=\"18\"></span><br><span class=\"line\" data-line-number=\"19\"></span><br><span class=\"line\" data-line-number=\"20\"></span><br><span class=\"line\" data-line-number=\"21\"></span><br><span class=\"line\" data-line-number=\"22\"></span><br><span class=\"line\" data-line-number=\"23\"></span><br><span class=\"line\" data-line-number=\"24\"></span><br><span class=\"line\" data-line-number=\"25\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">map</span> <span class=\"variable\">$http_upgrade</span> <span class=\"variable\">$connection_upgrade</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">default</span> upgrade;</span><br><span class=\"line\">    ''      close;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">443</span> ssl;</span><br><span class=\"line\">    <span class=\"attribute\">ssl_protocols</span>       TLSv1 TLSv1.<span class=\"number\">1</span> TLSv1.<span class=\"number\">2</span>;</span><br><span class=\"line\">    <span class=\"attribute\">ssl_ciphers</span>         HIGH:!aNULL:!MD5;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span>         __server_name__;</span><br><span class=\"line\">    <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_redirect</span>      <span class=\"literal\">off</span>;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_http_version</span>  <span class=\"number\">1</span>.<span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_set_header</span>    Upgrade <span class=\"variable\">$http_upgrade</span>;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_set_header</span>    Connection <span class=\"variable\">$connection_upgrade</span>;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_set_header</span>    Host <span class=\"variable\">$http_host</span>;</span><br><span class=\"line\">        <span class=\"attribute\">if</span> (<span class=\"variable\">$http_upgrade</span> = <span class=\"string\">\"websocket\"</span>)&#123;</span><br><span class=\"line\">            <span class=\"attribute\">proxy_pass</span>          http://192.168.0.118:10000;</span><br><span class=\"line\">            break;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"attribute\">if</span> (<span class=\"variable\">$scheme</span> = <span class=\"string\">\"http\"</span>)&#123;</span><br><span class=\"line\">            <span class=\"attribute\">return</span> <span class=\"number\">301</span> https://<span class=\"variable\">$http_host</span><span class=\"variable\">$request_uri</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>如果使用Nginx 反代，Andorid 的 simple-obfs 的版本使用的 obfs-local 是0.0.2 對 websocket的支持不完整。</p>\n<p>需要更新到最新版本的 obfs-local</p>\n<p><a href=\"https://github.com/Tsuki/simple-obfs-android/releases/download/0.0.6/obfs-local-release.apk\" target=\"_blank\" rel=\"noopener\">https://github.com/Tsuki/simple-obfs-android/releases/download/0.0.6/obfs-local-release.apk</a></p>\n","text":"一般Shadowsocks 機場，直接到服務器的真實IP，這種VPS服務器的IP 段都是連著的，出較出名的VPS服務商的IP 段很易被掃出來，之後被各種DDOS或暴力破解。使用CDN反代就可以把IP 隱藏起來，也可以把被GFW 封了的IP 段機器再利用。別外加上Nginx 反代可","link":"","raw":null,"photos":["/2018/11/29/使用CDN把SS主機的實體IP隱藏/photo_2018-11-29_11-12-19.jpg"],"source":"_posts/2018/11/29-使用CDN把SS主機的實體IP隱藏.md","categories":[{"name":"Server","slug":"Server","count":1,"path":"api/categories/Server.json"}],"tags":[]}]}