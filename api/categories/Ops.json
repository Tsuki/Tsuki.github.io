{"name":"Ops","slug":"Ops","count":6,"postlist":[{"_id":"cjk10tqv60000rjqbywt8gx5k","title":"ServerUpdate","slug":"ServerUpdate","date":"2018-07-25T14:11:07.000Z","updated":"2018-07-25T11:03:21.723Z","comments":true,"permalink":"/2018/07/25/ServerUpdate/","path":"api/articles/ServerUpdate.json","excerpt":"","keywords":null,"content":"<h1 id=\"服務器更新\"><a href=\"#服務器更新\" class=\"headerlink\" title=\"服務器更新\"></a>服務器更新</h1><p>今天把Debian滾到 9.5 內核升到 4.9, 因為Linux 4.9內核內建了tcp_bbr 算法。</p>\n<p>這算法對高延遲，高掉包的網絡有較大的提升</p>\n<p>不過香港的掉包和延遲不算嚴重，更新後提升不大</p>\n<h2 id=\"配置kernal-參數\"><a href=\"#配置kernal-參數\" class=\"headerlink\" title=\"配置kernal 參數\"></a>配置kernal 參數</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ vim /etc/sysctl.conf</span><br><span class=\"line\"><span class=\"comment\"># 增加以下兩條配置</span></span><br><span class=\"line\"><span class=\"comment\"># net.core.default_qdisc=fq</span></span><br><span class=\"line\"><span class=\"comment\"># net.ipv4.tcp_congestion_control=bbr</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"刷新內核配置\"><a href=\"#刷新內核配置\" class=\"headerlink\" title=\"刷新內核配置\"></a>刷新內核配置</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ sysctl -p</span><br></pre></td></tr></table></figure>\n<h2 id=\"重啟和測試配置\"><a href=\"#重啟和測試配置\" class=\"headerlink\" title=\"重啟和測試配置\"></a>重啟和測試配置</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ reboot</span><br><span class=\"line\">$ sysctl net.ipv4.tcp_available_congestion_control</span><br><span class=\"line\"><span class=\"comment\"># 顯示結果中有bbr</span></span><br><span class=\"line\"><span class=\"comment\"># net.ipv4.tcp_available_congestion_control = bbr cubic reno</span></span><br></pre></td></tr></table></figure>\n<p>測試用指令 <code>wget -qO- bench.sh | bash</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">----------------------------------------------------------------------</span><br><span class=\"line\">CPU model            : AMD Phenom(tm) II X6 1055T Processor</span><br><span class=\"line\">Number of cores      : 6</span><br><span class=\"line\">CPU frequency        : 2812.247 MHz</span><br><span class=\"line\">Total size of Disk   : 95.0 GB (38.0 GB Used)</span><br><span class=\"line\">Total amount of Mem  : 491 MB (84 MB Used)</span><br><span class=\"line\">Total amount of Swap : 4090 MB (0 MB Used)</span><br><span class=\"line\">System uptime        : 0 days, 0 hour 5 min</span><br><span class=\"line\">Load average         : 0.06, 0.08, 0.04</span><br><span class=\"line\">OS                   : Debian GNU/Linux 9</span><br><span class=\"line\">Arch                 : x86_64 (64 Bit)</span><br><span class=\"line\">Kernel               : 4.9.0-6-amd64</span><br><span class=\"line\">----------------------------------------------------------------------</span><br><span class=\"line\">I/O speed(1st run)   : 93.1 MB/s</span><br><span class=\"line\">I/O speed(2nd run)   : 93.5 MB/s</span><br><span class=\"line\">I/O speed(3rd run)   : 97.0 MB/s</span><br><span class=\"line\">Average I/O speed    : 94.5 MB/s</span><br><span class=\"line\">----------------------------------------------------------------------</span><br><span class=\"line\">Node Name                       IPv4 address            Download Speed</span><br><span class=\"line\">CacheFly                        204.93.150.152          5.14MB/s</span><br><span class=\"line\">Linode, Tokyo, JP               106.187.96.148          1.12MB/s</span><br><span class=\"line\">Linode, Singapore, SG           139.162.23.4            1.29MB/s</span><br><span class=\"line\">Linode, London, UK              176.58.107.39           578KB/s</span><br><span class=\"line\">Linode, Frankfurt, DE           139.162.130.8           546KB/s</span><br><span class=\"line\">Linode, Fremont, CA             50.116.14.9             634KB/s</span><br><span class=\"line\">Softlayer, Dallas, TX           173.192.68.18           1.70MB/s</span><br><span class=\"line\">Softlayer, Seattle, WA          67.228.112.250          2.06MB/s</span><br><span class=\"line\">Softlayer, Frankfurt, DE        159.122.69.4            237KB/s</span><br><span class=\"line\">Softlayer, Singapore, SG        119.81.28.170           1.45MB/s</span><br><span class=\"line\">Softlayer, HongKong, CN         119.81.130.170          8.97MB/s</span><br><span class=\"line\">----------------------------------------------------------------------</span><br><span class=\"line\">SpeedTest</span><br><span class=\"line\">Hosted by STC (Hong Kong) : 5.976 ms</span><br><span class=\"line\">Testing download </span><br><span class=\"line\">Download: 289.92 Mbit/s</span><br><span class=\"line\">Testing upload </span><br><span class=\"line\">Upload: 52.48 Mbit/s</span><br></pre></td></tr></table></figure>\n","text":"服務器更新今天把Debian滾到 9.5 內核升到 4.9, 因為Linux 4.9內核內建了tcp_bbr 算法。這算法對高延遲，高掉包的網絡有較大的提升不過香港的掉包和延遲不算嚴重，更新後提升不大配置kernal 參數1<br>2<br>3<br>4<br>$ vim /et","link":"","raw":null,"photos":["https://blog.sukitsuki.com/2018/07/25/ServerUpdate/cjk0s2e3n00058i5n2cg1ayq9.jpg"],"source":"_posts/2018/07/25-ServerUpdate.md","categories":[{"name":"Ops","slug":"Ops","count":6,"path":"api/categories/Ops.json"}],"tags":[]},{"_id":"cjkaqch760000rdm6t3obegeg","title":"Mac 虛擬化","slug":"Mac-Hypervisor","date":"2018-08-01T11:53:59.000Z","updated":"2018-08-18T13:01:30.765Z","comments":true,"permalink":"/2018/08/01/Mac-Hypervisor/","path":"api/articles/Mac-Hypervisor.json","excerpt":"","keywords":null,"content":"<h1 id=\"Mac-虛擬化管理\"><a href=\"#Mac-虛擬化管理\" class=\"headerlink\" title=\"Mac 虛擬化管理\"></a>Mac 虛擬化管理</h1><h2 id=\"虛擬化\"><a href=\"#虛擬化\" class=\"headerlink\" title=\"虛擬化\"></a>虛擬化</h2><p>在 Linux 世界中，要實現進程/資源分離並不是一件非常困難的事情，從最早的 chroot, 到後來 Google 提出的 cgroups (Control groups), 到後來實用化的 LXC ，或者是系統級虛擬化 KVM,XEN 等。</p>\n<p>相比起 Linux 的 cgroups (2006年), FreeBSD 在更早之前(2000年),就提出過相似的沙箱虛擬化技術 jail, 並且提供不少實用功能，比如打包轉移，虛擬網絡監控等功能。</p>\n<h3 id=\"bhyve-xhyve\"><a href=\"#bhyve-xhyve\" class=\"headerlink\" title=\"bhyve/xhyve\"></a>bhyve/xhyve</h3><p>雖然 jail 能提供像 Docker 的功能，但 Docker 的社群相比 Unix/BSD 社群人數更多，支援也更成熟。為了在Unix上便用 Docker, 但Docker 是基於 Linux 內核開發，要提供內核就只能便用 Virtual Box 等方案，直到 bhyve 的出現（續命。 bhyve 的出現令 Unix 拥有低成本，高效和原生的虛擬化體驗，使用起來更流暢。</p>\n<p>作為師出同門的 Mac 要使用這項技術，因此就出現從BSD bhyve 移植而來的 xhyve. (Mac 內核是從 BSD 原碼上分支而來)</p>\n<h3 id=\"HyperKit\"><a href=\"#HyperKit\" class=\"headerlink\" title=\"HyperKit\"></a>HyperKit</h3><p>HyperKit 是Docker 公司基於 b/xhyve 開發的工具庫，用作提升擴屏性和兼容性的解決方案。現時新版本的 Docker for Mac 就內置了 HyperKit.</p>\n","text":"Mac 虛擬化管理虛擬化在 Linux 世界中，要實現進程/資源分離並不是一件非常困難的事情，從最早的 chroot, 到後來 Google 提出的 cgroups (Control groups), 到後來實用化的 LXC ，或者是系統級虛擬化 KVM,XEN 等。相比起 Li","link":"","raw":null,"photos":["/2018/08/01/Mac-Hypervisor/cjk84ozko000c8i5nmlk52wsl.jpg"],"source":"_posts/2018/08/01-Mac-Hypervisor.md","categories":[{"name":"Ops","slug":"Ops","count":6,"path":"api/categories/Ops.json"}],"tags":[]},{"_id":"cjkdzz28z0000rjkx0u710iub","title":"從Gogs遷移到Gitea","slug":"From-gogs-to-gitea","date":"2018-08-03T18:18:01.000Z","updated":"2018-08-18T13:01:30.765Z","comments":true,"permalink":"/2018/08/03/From-gogs-to-gitea/","path":"api/articles/From-gogs-to-gitea.json","excerpt":"","keywords":null,"content":"<p>Gogs 其實一個升級版本引起奇怪事情，於是順便遷移到 Gitea 上，在 Gitea 官方上建意由 0.9.X 或以前升級會比較方便。</p>\n<p>但我升級到 0.11.X 以上出現問題，所在這記錄一下解決過程。</p>\n<h1 id=\"起因\"><a href=\"#起因\" class=\"headerlink\" title=\"起因\"></a>起因</h1><p>事源於新版 Gogs 加了/修改了 git hook 的處理方法，兼容上出現一些問題。 在推送時出現 hook declined 並被 reject.</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\">! [remote rejected] master -&gt; master (pre-receive hook declined)</span><br></pre></td></tr></table></figure>\n<p>可能的成因是這個hook不再生效或不再兼容了</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br><span class=\"line\" data-line-number=\"2\"></span><br><span class=\"line\" data-line-number=\"3\"></span><br><span class=\"line\" data-line-number=\"4\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#在 /var/gogs/git/gogs-repositories/&lt;user&gt;/&lt;repo&gt;.git/hooks/pre-receiv</span></span><br><span class=\"line\"><span class=\"comment\">#找到以下內容</span></span><br><span class=\"line\"><span class=\"meta\">#!/usr/bin/env bash</span></span><br><span class=\"line\"><span class=\"string\">\"/app/gogs/gogs\"</span> hook --config=<span class=\"string\">'/data/gogs/conf/app.ini'</span> pre-receive</span><br></pre></td></tr></table></figure>\n<h1 id=\"遷移\"><a href=\"#遷移\" class=\"headerlink\" title=\"遷移\"></a>遷移</h1><p>Gitea 是 Gogs 在 0.9.X 上分支，並後續開發的版本。</p>\n<h2 id=\"使用Docker-作為啟動\"><a href=\"#使用Docker-作為啟動\" class=\"headerlink\" title=\"使用Docker 作為啟動\"></a>使用Docker 作為啟動</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br><span class=\"line\" data-line-number=\"2\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -d --name=gitea -p 10022:22 -p 10080:3000 -v /var/lib/gitea:/data gitea/gitea:latest</span><br><span class=\"line\">docker stop gitea</span><br></pre></td></tr></table></figure>\n<h2 id=\"遷移-git-倉庫和數據庫\"><a href=\"#遷移-git-倉庫和數據庫\" class=\"headerlink\" title=\"遷移 git 倉庫和數據庫\"></a>遷移 git 倉庫和數據庫</h2><p>複制倉庫到 Gitea</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br><span class=\"line\" data-line-number=\"2\"></span><br><span class=\"line\" data-line-number=\"3\"></span><br><span class=\"line\" data-line-number=\"4\"></span><br><span class=\"line\" data-line-number=\"5\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cp -r /var/gogs/git/gogs-repositories/* /var/lib/gitea/git/repositories/</span><br><span class=\"line\"><span class=\"built_in\">cd</span> /var/lib/gitea/gitea/conf</span><br><span class=\"line\">mv app.ini app.ini.bak</span><br><span class=\"line\">cp /var/gogs/gogs/conf/app.ini .</span><br><span class=\"line\">vim app.ini</span><br></pre></td></tr></table></figure>\n<p>複制數據庫</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CREATE DATABASE gitea WITH TEMPLATE gogs OWNER &lt;username&gt;;</span><br></pre></td></tr></table></figure>\n<p>修改 Gitea 參數</p>\n<figure class=\"highlight toml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br><span class=\"line\" data-line-number=\"2\"></span><br><span class=\"line\" data-line-number=\"3\"></span><br><span class=\"line\" data-line-number=\"4\"></span><br><span class=\"line\" data-line-number=\"5\"></span><br><span class=\"line\" data-line-number=\"6\"></span><br><span class=\"line\" data-line-number=\"7\"></span><br><span class=\"line\" data-line-number=\"8\"></span><br><span class=\"line\" data-line-number=\"9\"></span><br><span class=\"line\" data-line-number=\"10\"></span><br><span class=\"line\" data-line-number=\"11\"></span><br><span class=\"line\" data-line-number=\"12\"></span><br><span class=\"line\" data-line-number=\"13\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[repository]</span></span><br><span class=\"line\"><span class=\"attr\">ROOT</span> = /data/git/repositories</span><br><span class=\"line\"><span class=\"section\">[server]</span></span><br><span class=\"line\"><span class=\"attr\">APP_DATA_PATH</span>    = /data/gitea</span><br><span class=\"line\"><span class=\"attr\">ROOT_URL</span>         = https://domain</span><br><span class=\"line\"><span class=\"attr\">DOMAIN</span>           = domain</span><br><span class=\"line\"><span class=\"section\">[database]</span></span><br><span class=\"line\"><span class=\"attr\">DB_TYPE</span>  = postgres</span><br><span class=\"line\"><span class=\"attr\">HOST</span>     = <span class=\"number\">172.17</span>.<span class=\"number\">0.1</span>:<span class=\"number\">5432</span> #docker 到外部 postgres SQL</span><br><span class=\"line\"><span class=\"attr\">NAME</span>     = gitea</span><br><span class=\"line\"><span class=\"attr\">USER</span>     = USER</span><br><span class=\"line\"><span class=\"attr\">PASSWD</span>   = PASSWD</span><br><span class=\"line\"><span class=\"attr\">SSL_MODE</span> = disable</span><br></pre></td></tr></table></figure>\n<h2 id=\"啟動並排錯\"><a href=\"#啟動並排錯\" class=\"headerlink\" title=\"啟動並排錯\"></a>啟動並排錯</h2><p>啟動 Docker </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker start gitea</span><br></pre></td></tr></table></figure>\n<p>查看 log 是否順利（通常都不順利</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\">less /var/lib/gitea/gitea/<span class=\"built_in\">log</span>/gitea.log</span><br></pre></td></tr></table></figure>\n<p> 如果看到收Migration出現問題（如下</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br><span class=\"line\" data-line-number=\"2\"></span><br><span class=\"line\" data-line-number=\"3\"></span><br><span class=\"line\" data-line-number=\"4\"></span><br><span class=\"line\" data-line-number=\"5\"></span><br><span class=\"line\" data-line-number=\"6\"></span><br><span class=\"line\" data-line-number=\"7\"></span><br><span class=\"line\" data-line-number=\"8\"></span><br><span class=\"line\" data-line-number=\"9\"></span><br><span class=\"line\" data-line-number=\"10\"></span><br><span class=\"line\" data-line-number=\"11\"></span><br><span class=\"line\" data-line-number=\"12\"></span><br><span class=\"line\" data-line-number=\"13\"></span><br><span class=\"line\" data-line-number=\"14\"></span><br><span class=\"line\" data-line-number=\"15\"></span><br><span class=\"line\" data-line-number=\"16\"></span><br><span class=\"line\" data-line-number=\"17\"></span><br><span class=\"line\" data-line-number=\"18\"></span><br><span class=\"line\" data-line-number=\"19\"></span><br><span class=\"line\" data-line-number=\"20\"></span><br><span class=\"line\" data-line-number=\"21\"></span><br><span class=\"line\" data-line-number=\"22\"></span><br><span class=\"line\" data-line-number=\"23\"></span><br><span class=\"line\" data-line-number=\"24\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">17</span> [I] Migration: empty step</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">17</span> [I] Migration: empty step</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">17</span> [I] Migration: empty step</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">17</span> [I] Migration: remove index column from repo_unit table</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">17</span> [I] Migration: remove organization watch repositories</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">17</span> [I] Migration: add deleted branches</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">18</span> [I] Migration: add repo indexer status</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">18</span> [I] Migration: adds time tracking and stopwatches</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">19</span> [I] Migration: migrate protected branch <span class=\"keyword\">struct</span></span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">19</span> [I] Migration: add <span class=\"keyword\">default</span> value to user prohibit_login</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">19</span> [I] Migration: add lfs lock table</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">20</span> [I] Migration: add reactions</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">20</span> [I] Migration: add pull request options</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">20</span> [I] Migration: add writable deploy keys</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">21</span> [I] Migration: remove is_owner, num_teams columns from org_user</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">21</span> [I] Migration: add closed_unix column <span class=\"keyword\">for</span> issues</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">22</span> [I] Migration: add label descriptions</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">22</span> [I] Migration: add merge whitelist <span class=\"keyword\">for</span> protected branches</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">23</span> [I] Migration: add is_fsck_enabled column <span class=\"keyword\">for</span> repos</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">23</span> [I] Migration: add size column <span class=\"keyword\">for</span> attachments</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">24</span> [I] Migration: add last used passcode column <span class=\"keyword\">for</span> TOTP</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">24</span> [I] Migration: add language column <span class=\"keyword\">for</span> user setting</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">25</span> [I] Migration: add multiple assignees</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">26</span> [...itea/routers/init.<span class=\"keyword\">go</span>:<span class=\"number\">60</span> GlobalInit()] [E] Failed to initialize ORM engine: migrate: do migrate: pq: column <span class=\"string\">\"ref\"</span> does not exist</span><br></pre></td></tr></table></figure>\n<p>出現欄位失蹤  <code>do migrate: pq: column &quot;ref&quot; does not exist</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br><span class=\"line\" data-line-number=\"2\"></span><br><span class=\"line\" data-line-number=\"3\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 查看 Migration 的版本</span><br><span class=\"line\">SELECT version FROM public.version t</span><br><span class=\"line\"># 顯示的是 64,</span><br></pre></td></tr></table></figure>\n<p>到 Github 上查看源碼 <a href=\"https://github.com/go-gitea/gitea/tree/master/models/migrations\" target=\"_blank\" rel=\"noopener\">https://github.com/go-gitea/gitea/tree/master/models/migrations</a></p>\n<p>找出 v64.go 並在 type Issue 或到要需要的 Ref</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ALTER TABLE public.issue ADD ref text NULL</span><br></pre></td></tr></table></figure>\n<p>再重啟 Docker 並繼續排查問題。</p>\n<h2 id=\"清理錯誤的-Hook\"><a href=\"#清理錯誤的-Hook\" class=\"headerlink\" title=\"清理錯誤的 Hook\"></a>清理錯誤的 Hook</h2><p>再次推送時，會出現新的錯誤 </p>\n<p><code>remote: ./hooks/post-receive.d/post-receive: line 2: /app/gogs/gogs: No such file or directory</code></p>\n<p>使用以下指令清理不需要的 Gogs Hook</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br><span class=\"line\" data-line-number=\"2\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /var/lib/gitea/git/repositories</span><br><span class=\"line\">grep -rHn gogs *|cut -d : -f1 | xargs rm</span><br></pre></td></tr></table></figure>\n<p>到這步為止，之前推送失敗的倉庫都能推送上服務器</p>\n","text":"Gogs 其實一個升級版本引起奇怪事情，於是順便遷移到 Gitea 上，在 Gitea 官方上建意由 0.9.X 或以前升級會比較方便。但我升級到 0.11.X 以上出現問題，所在這記錄一下解決過程。起因事源於新版 Gogs 加了/修改了 git hook 的處理方法，兼容上出現","link":"","raw":null,"photos":["/2018/08/03/From-gogs-to-gitea/cjkbrtbs501458i5nw9jtl9m4.jpg"],"source":"_posts/2018/08/03-From-gogs-to-gitea.md","categories":[{"name":"Ops","slug":"Ops","count":6,"path":"api/categories/Ops.json"}],"tags":[]},{"_id":"cjke00vpc0000r4pc3bb16088","title":"GPG-Key","slug":"GPG-key","date":"2018-08-03T15:32:10.000Z","updated":"2018-08-04T10:03:24.706Z","comments":true,"permalink":"/2018/08/03/GPG-key/","path":"api/articles/GPG-key.json","excerpt":"","keywords":null,"content":"<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 開啟 GPG sign</span></span><br><span class=\"line\">git config --global commit.gpgsign <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"comment\"># 指定 sign key</span></span><br><span class=\"line\">git config --global user.signingkey &lt;key&gt;</span><br><span class=\"line\"><span class=\"comment\"># 顯示 公鈅列表</span></span><br><span class=\"line\">gpg --list-keys --keyid-format LONG</span><br><span class=\"line\"><span class=\"comment\"># 顯示 私鈅列表</span></span><br><span class=\"line\">gpg --list-secret-keys --keyid-format LONG</span><br><span class=\"line\"><span class=\"comment\"># 生成 Key</span></span><br><span class=\"line\">gpg --full-generate-key</span><br><span class=\"line\"><span class=\"comment\"># 導出公鈅</span></span><br><span class=\"line\">gpg --armor --<span class=\"built_in\">export</span> &lt;key&gt;</span><br><span class=\"line\"><span class=\"comment\"># 導出密鈅</span></span><br><span class=\"line\">gpg --armor --<span class=\"built_in\">export</span>-secret-keys &lt;key&gt;</span><br><span class=\"line\"><span class=\"comment\"># 導出子密鈅</span></span><br><span class=\"line\">gpg --armor --<span class=\"built_in\">export</span>-secret-subkeys &lt;key&gt;</span><br><span class=\"line\"><span class=\"comment\"># 重啟 gpg agent</span></span><br><span class=\"line\">gpg-connect-agent reloadagent /<span class=\"built_in\">bye</span></span><br><span class=\"line\"><span class=\"comment\"># 殺掉 gpg agent</span></span><br><span class=\"line\">gpgconf --<span class=\"built_in\">kill</span> gpg-agent</span><br><span class=\"line\"><span class=\"comment\"># 修改 gpg agent 參數</span></span><br><span class=\"line\">vim ~/.gnupg/gpg-agent.conf</span><br><span class=\"line\">max-cache-ttl 60480000</span><br><span class=\"line\">default-cache-ttl 60480000</span><br></pre></td></tr></table></figure>\n","text":"1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br># 開啟 ","link":"","raw":null,"photos":[],"source":"_posts/2018/08/03-GPG-key.md","categories":[{"name":"Ops","slug":"Ops","count":6,"path":"api/categories/Ops.json"}],"tags":[]},{"_id":"cjkl3e31n0000tpms4oney5to","title":"DNS故障轉移測試","slug":"DNS-High-Availability","date":"2018-08-08T18:34:05.000Z","updated":"2018-12-10T11:08:42.291Z","comments":true,"permalink":"/2018/08/08/DNS-High-Availability/","path":"api/articles/DNS-High-Availability.json","excerpt":"","keywords":null,"content":"<p>建立 lookback 地址</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo ifconfig lo0 <span class=\"built_in\">alias</span> 127.0.0.2 up</span><br><span class=\"line\">sudo ifconfig lo0 <span class=\"built_in\">alias</span> 127.0.0.3 up</span><br></pre></td></tr></table></figure>\n<p>在 hosts 加入本地 dns 記錄</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo vim /etc/hosts</span><br><span class=\"line\">127.0.0.1 localhost</span><br><span class=\"line\">127.0.0.2 localhost</span><br><span class=\"line\">127.0.0.3 localhost</span><br></pre></td></tr></table></figure>\n<p>在不同終端使用 netcat 建立本地監聽 </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nc -lk 127.0.0.1 8080</span><br><span class=\"line\">nc -lk 127.0.0.2 8080</span><br><span class=\"line\">nc -lk 127.0.0.3 8080</span><br></pre></td></tr></table></figure>\n<p>測試傳送信息</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nc localhost 8080</span><br></pre></td></tr></table></figure>\n<p>嘗試關閉不同終端 以測試能不能故障轉移</p>\n","text":"建立 lookback 地址1<br>2<br>sudo ifconfig lo0 alias 127.0.0.2 up<br>sudo ifconfig lo0 alias 127.0.0.3 up<br>在 hosts 加入本地 dns 記錄1<br>2<br>3<br>4<","link":"","raw":null,"photos":["/2018/08/08/DNS-High-Availability/cjkewl4ic018e8i5nkqukol2w.1200.jpg"],"source":"_posts/2018/08/08-DNS-High-Availability.md","categories":[{"name":"Ops","slug":"Ops","count":6,"path":"api/categories/Ops.json"}],"tags":[]},{"_id":"cjl297e6e0000u4noni3wptzk","title":"Docker清理","slug":"Docker清理","date":"2018-08-20T20:01:56.000Z","updated":"2018-08-20T12:25:09.461Z","comments":true,"permalink":"/2018/08/20/Docker清理/","path":"api/articles/Docker清理.json","excerpt":"","keywords":null,"content":"<h3 id=\"查看已使用空間\"><a href=\"#查看已使用空間\" class=\"headerlink\" title=\"查看已使用空間\"></a>查看已使用空間</h3><blockquote>\n<p>docker system df</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br><span class=\"line\" data-line-number=\"2\"></span><br><span class=\"line\" data-line-number=\"3\"></span><br><span class=\"line\" data-line-number=\"4\"></span><br><span class=\"line\" data-line-number=\"5\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TYPE                TOTAL               ACTIVE              SIZE                RECLAIMABLE</span><br><span class=\"line\">Images              17                  15                  5.531GB             1.822GB (32%)</span><br><span class=\"line\">Containers          20                  1                   251.6MB             212.2MB (84%)</span><br><span class=\"line\">Local Volumes       42                  17                  1.09GB              174.5MB (16%)</span><br><span class=\"line\">Build Cache         0                   0                   0B                  0B</span><br></pre></td></tr></table></figure>\n<h3 id=\"清理空間\"><a href=\"#清理空間\" class=\"headerlink\" title=\"清理空間\"></a>清理空間</h3><p>Remove local volumes not used by at least one container - 沒有在使用的空間</p>\n<blockquote>\n<p>docker volume prune</p>\n</blockquote>\n<h3 id=\"清理容器\"><a href=\"#清理容器\" class=\"headerlink\" title=\"清理容器\"></a>清理容器</h3><p>Remove all stopped containers - 己停用的容器</p>\n<blockquote>\n<p>docker container prune</p>\n</blockquote>\n<h3 id=\"清理影像\"><a href=\"#清理影像\" class=\"headerlink\" title=\"清理影像\"></a>清理影像</h3><p>Remove dangling images - 沒有被tag的影像層</p>\n<blockquote>\n<p>docker image prune</p>\n</blockquote>\n<p>Remove images without at least one container associated - 沒有在使用的影像</p>\n<blockquote>\n<p>docker image prune -a</p>\n</blockquote>\n<h3 id=\"全面清理\"><a href=\"#全面清理\" class=\"headerlink\" title=\"全面清理\"></a>全面清理</h3><ul>\n<li>Remove stopped containers - 己停用的容器</li>\n<li>Remove networks not used by at least one container - 沒有容器連接的網絡</li>\n<li>Remove dangling images - 沒有被tag</li>\n<li>Remove build cache - 構建快取</li>\n</ul>\n<blockquote>\n<p>docker system prune</p>\n</blockquote>\n","text":"查看已使用空間docker system df<br><br><br><br><br>TYPE                TOTAL               ACTIVE              SIZE                RECLAIMABLE<br>Im","link":"","raw":null,"photos":["/2018/08/20/Docker清理/3GtH1bB.jpg"],"source":"_posts/2018/08/20-Docker清理.md","categories":[{"name":"Ops","slug":"Ops","count":6,"path":"api/categories/Ops.json"}],"tags":[]}]}