{"title":"從Gogs遷移到Gitea","slug":"From-gogs-to-gitea","date":"2018-08-03T18:18:01.000Z","updated":"2018-08-18T13:01:30.765Z","comments":true,"path":"api/articles/2018/08/03/From-gogs-to-gitea.json","photos":["/2018/08/03/From-gogs-to-gitea/cjkbrtbs501458i5nw9jtl9m4.jpg"],"link":"","excerpt":"Gogs 其實一個升級版本引起奇怪事情，於是順便遷移到 Gitea 上，在 Gitea 官方上建意由 0.9.X 或以前升級會比較方便。但我升級到 0.11.X 以上出現問題，所在這記錄一下解決過程。起因事源於新版 Gogs 加了/修改了 git hook 的處理方法，兼容上出現一些問題。 在推送時出現 hook declined 並被 reject.<br>! [remote rejected] master -&gt; master (pre-receive hook declined)<br>可能的成因是這個hook不再生效或不再兼容了<br><br><br><br>#在 /var/gogs/git/gogs-repositories/&lt;user&gt;/&lt;repo&gt;.git/hooks/pre-receiv<br>#找到以下內容<br>#!/usr/bin/env bash<br>\"/app/gogs/gogs\" hook --config='/data/gogs/conf/app.ini' pre-receive<br>遷移Gitea 是 Gogs 在 0.9.X 上分支，並後續開發的版本。使用Docker 作為啟動","content":"<p>Gogs 其實一個升級版本引起奇怪事情，於是順便遷移到 Gitea 上，在 Gitea 官方上建意由 0.9.X 或以前升級會比較方便。</p>\n<p>但我升級到 0.11.X 以上出現問題，所在這記錄一下解決過程。</p>\n<h1 id=\"起因\"><a href=\"#起因\" class=\"headerlink\" title=\"起因\"></a>起因</h1><p>事源於新版 Gogs 加了/修改了 git hook 的處理方法，兼容上出現一些問題。 在推送時出現 hook declined 並被 reject.</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\">! [remote rejected] master -&gt; master (pre-receive hook declined)</span><br></pre></td></tr></table></figure>\n<p>可能的成因是這個hook不再生效或不再兼容了</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br><span class=\"line\" data-line-number=\"2\"></span><br><span class=\"line\" data-line-number=\"3\"></span><br><span class=\"line\" data-line-number=\"4\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#在 /var/gogs/git/gogs-repositories/&lt;user&gt;/&lt;repo&gt;.git/hooks/pre-receiv</span></span><br><span class=\"line\"><span class=\"comment\">#找到以下內容</span></span><br><span class=\"line\"><span class=\"meta\">#!/usr/bin/env bash</span></span><br><span class=\"line\"><span class=\"string\">\"/app/gogs/gogs\"</span> hook --config=<span class=\"string\">'/data/gogs/conf/app.ini'</span> pre-receive</span><br></pre></td></tr></table></figure>\n<h1 id=\"遷移\"><a href=\"#遷移\" class=\"headerlink\" title=\"遷移\"></a>遷移</h1><p>Gitea 是 Gogs 在 0.9.X 上分支，並後續開發的版本。</p>\n<h2 id=\"使用Docker-作為啟動\"><a href=\"#使用Docker-作為啟動\" class=\"headerlink\" title=\"使用Docker 作為啟動\"></a>使用Docker 作為啟動</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br><span class=\"line\" data-line-number=\"2\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -d --name=gitea -p 10022:22 -p 10080:3000 -v /var/lib/gitea:/data gitea/gitea:latest</span><br><span class=\"line\">docker stop gitea</span><br></pre></td></tr></table></figure>\n<h2 id=\"遷移-git-倉庫和數據庫\"><a href=\"#遷移-git-倉庫和數據庫\" class=\"headerlink\" title=\"遷移 git 倉庫和數據庫\"></a>遷移 git 倉庫和數據庫</h2><p>複制倉庫到 Gitea</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br><span class=\"line\" data-line-number=\"2\"></span><br><span class=\"line\" data-line-number=\"3\"></span><br><span class=\"line\" data-line-number=\"4\"></span><br><span class=\"line\" data-line-number=\"5\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cp -r /var/gogs/git/gogs-repositories/* /var/lib/gitea/git/repositories/</span><br><span class=\"line\"><span class=\"built_in\">cd</span> /var/lib/gitea/gitea/conf</span><br><span class=\"line\">mv app.ini app.ini.bak</span><br><span class=\"line\">cp /var/gogs/gogs/conf/app.ini .</span><br><span class=\"line\">vim app.ini</span><br></pre></td></tr></table></figure>\n<p>複制數據庫</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CREATE DATABASE gitea WITH TEMPLATE gogs OWNER &lt;username&gt;;</span><br></pre></td></tr></table></figure>\n<p>修改 Gitea 參數</p>\n<figure class=\"highlight toml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br><span class=\"line\" data-line-number=\"2\"></span><br><span class=\"line\" data-line-number=\"3\"></span><br><span class=\"line\" data-line-number=\"4\"></span><br><span class=\"line\" data-line-number=\"5\"></span><br><span class=\"line\" data-line-number=\"6\"></span><br><span class=\"line\" data-line-number=\"7\"></span><br><span class=\"line\" data-line-number=\"8\"></span><br><span class=\"line\" data-line-number=\"9\"></span><br><span class=\"line\" data-line-number=\"10\"></span><br><span class=\"line\" data-line-number=\"11\"></span><br><span class=\"line\" data-line-number=\"12\"></span><br><span class=\"line\" data-line-number=\"13\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[repository]</span></span><br><span class=\"line\"><span class=\"attr\">ROOT</span> = /data/git/repositories</span><br><span class=\"line\"><span class=\"section\">[server]</span></span><br><span class=\"line\"><span class=\"attr\">APP_DATA_PATH</span>    = /data/gitea</span><br><span class=\"line\"><span class=\"attr\">ROOT_URL</span>         = https://domain</span><br><span class=\"line\"><span class=\"attr\">DOMAIN</span>           = domain</span><br><span class=\"line\"><span class=\"section\">[database]</span></span><br><span class=\"line\"><span class=\"attr\">DB_TYPE</span>  = postgres</span><br><span class=\"line\"><span class=\"attr\">HOST</span>     = <span class=\"number\">172.17</span>.<span class=\"number\">0.1</span>:<span class=\"number\">5432</span> #docker 到外部 postgres SQL</span><br><span class=\"line\"><span class=\"attr\">NAME</span>     = gitea</span><br><span class=\"line\"><span class=\"attr\">USER</span>     = USER</span><br><span class=\"line\"><span class=\"attr\">PASSWD</span>   = PASSWD</span><br><span class=\"line\"><span class=\"attr\">SSL_MODE</span> = disable</span><br></pre></td></tr></table></figure>\n<h2 id=\"啟動並排錯\"><a href=\"#啟動並排錯\" class=\"headerlink\" title=\"啟動並排錯\"></a>啟動並排錯</h2><p>啟動 Docker </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker start gitea</span><br></pre></td></tr></table></figure>\n<p>查看 log 是否順利（通常都不順利</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\">less /var/lib/gitea/gitea/<span class=\"built_in\">log</span>/gitea.log</span><br></pre></td></tr></table></figure>\n<p> 如果看到收Migration出現問題（如下</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br><span class=\"line\" data-line-number=\"2\"></span><br><span class=\"line\" data-line-number=\"3\"></span><br><span class=\"line\" data-line-number=\"4\"></span><br><span class=\"line\" data-line-number=\"5\"></span><br><span class=\"line\" data-line-number=\"6\"></span><br><span class=\"line\" data-line-number=\"7\"></span><br><span class=\"line\" data-line-number=\"8\"></span><br><span class=\"line\" data-line-number=\"9\"></span><br><span class=\"line\" data-line-number=\"10\"></span><br><span class=\"line\" data-line-number=\"11\"></span><br><span class=\"line\" data-line-number=\"12\"></span><br><span class=\"line\" data-line-number=\"13\"></span><br><span class=\"line\" data-line-number=\"14\"></span><br><span class=\"line\" data-line-number=\"15\"></span><br><span class=\"line\" data-line-number=\"16\"></span><br><span class=\"line\" data-line-number=\"17\"></span><br><span class=\"line\" data-line-number=\"18\"></span><br><span class=\"line\" data-line-number=\"19\"></span><br><span class=\"line\" data-line-number=\"20\"></span><br><span class=\"line\" data-line-number=\"21\"></span><br><span class=\"line\" data-line-number=\"22\"></span><br><span class=\"line\" data-line-number=\"23\"></span><br><span class=\"line\" data-line-number=\"24\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">17</span> [I] Migration: empty step</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">17</span> [I] Migration: empty step</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">17</span> [I] Migration: empty step</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">17</span> [I] Migration: remove index column from repo_unit table</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">17</span> [I] Migration: remove organization watch repositories</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">17</span> [I] Migration: add deleted branches</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">18</span> [I] Migration: add repo indexer status</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">18</span> [I] Migration: adds time tracking and stopwatches</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">19</span> [I] Migration: migrate protected branch <span class=\"keyword\">struct</span></span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">19</span> [I] Migration: add <span class=\"keyword\">default</span> value to user prohibit_login</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">19</span> [I] Migration: add lfs lock table</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">20</span> [I] Migration: add reactions</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">20</span> [I] Migration: add pull request options</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">20</span> [I] Migration: add writable deploy keys</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">21</span> [I] Migration: remove is_owner, num_teams columns from org_user</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">21</span> [I] Migration: add closed_unix column <span class=\"keyword\">for</span> issues</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">22</span> [I] Migration: add label descriptions</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">22</span> [I] Migration: add merge whitelist <span class=\"keyword\">for</span> protected branches</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">23</span> [I] Migration: add is_fsck_enabled column <span class=\"keyword\">for</span> repos</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">23</span> [I] Migration: add size column <span class=\"keyword\">for</span> attachments</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">24</span> [I] Migration: add last used passcode column <span class=\"keyword\">for</span> TOTP</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">24</span> [I] Migration: add language column <span class=\"keyword\">for</span> user setting</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">25</span> [I] Migration: add multiple assignees</span><br><span class=\"line\"><span class=\"number\">2018</span>/<span class=\"number\">08</span>/<span class=\"number\">03</span> <span class=\"number\">10</span>:<span class=\"number\">58</span>:<span class=\"number\">26</span> [...itea/routers/init.<span class=\"keyword\">go</span>:<span class=\"number\">60</span> GlobalInit()] [E] Failed to initialize ORM engine: migrate: do migrate: pq: column <span class=\"string\">\"ref\"</span> does not exist</span><br></pre></td></tr></table></figure>\n<p>出現欄位失蹤  <code>do migrate: pq: column &quot;ref&quot; does not exist</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br><span class=\"line\" data-line-number=\"2\"></span><br><span class=\"line\" data-line-number=\"3\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 查看 Migration 的版本</span><br><span class=\"line\">SELECT version FROM public.version t</span><br><span class=\"line\"># 顯示的是 64,</span><br></pre></td></tr></table></figure>\n<p>到 Github 上查看源碼 <a href=\"https://github.com/go-gitea/gitea/tree/master/models/migrations\" target=\"_blank\" rel=\"noopener\">https://github.com/go-gitea/gitea/tree/master/models/migrations</a></p>\n<p>找出 v64.go 並在 type Issue 或到要需要的 Ref</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ALTER TABLE public.issue ADD ref text NULL</span><br></pre></td></tr></table></figure>\n<p>再重啟 Docker 並繼續排查問題。</p>\n<h2 id=\"清理錯誤的-Hook\"><a href=\"#清理錯誤的-Hook\" class=\"headerlink\" title=\"清理錯誤的 Hook\"></a>清理錯誤的 Hook</h2><p>再次推送時，會出現新的錯誤 </p>\n<p><code>remote: ./hooks/post-receive.d/post-receive: line 2: /app/gogs/gogs: No such file or directory</code></p>\n<p>使用以下指令清理不需要的 Gogs Hook</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\" data-line-number=\"1\"></span><br><span class=\"line\" data-line-number=\"2\"></span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /var/lib/gitea/git/repositories</span><br><span class=\"line\">grep -rHn gogs *|cut -d : -f1 | xargs rm</span><br></pre></td></tr></table></figure>\n<p>到這步為止，之前推送失敗的倉庫都能推送上服務器</p>\n","prev":{"title":"身為男高中生...讀後感","link":"/2018/08/06/身為男高中生-讀後感"},"next":{"title":"GPG-Key","link":"/2018/08/03/GPG-key"},"categories":[{"name":"Ops","slug":"Ops","count":6,"path":"api/categories/Ops.json"}],"tags":[]}