{"title":"Angular-起動時加入Async和defer","slug":"Angular-起動時加入async和defer","date":"2018-12-15T13:40:11.000Z","updated":"2018-12-18T07:34:52.135Z","comments":true,"path":"api/articles/2018/12/15/Angular-起動時加入async和defer.json","photos":["/2018/12/15/Angular-起動時加入async和defer/cjp40c7j60006wo8hur6fyehw.720p.jpg"],"link":"","excerpt":"首先，在 Angular 不 Eject 的情況下，使用其他的 Webpack plugin，這樣需要引入 ngx-build-plus。1<br>npm install ngx-build-plus<br>之後在 angular.json 替換 angular-cli 本來的引導指令1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>...<br>  \"architect\": &#123;<br>    \"build\": &#123;<br>      \"builder\": \"ngx-build-plus:build\",<br>      ...<br>    &#125;<br>    \"serve\": &#123;<br>       \"builder\": \"ngx-build-plus:dev-server\",<br>       ...<br>    &#125;<br>  &#125;<br>...<br>別外，在目錄下加入額外的 Webpack 配置文件 webpack.extra.js1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>const HtmlWebpackPlugin = require('html-webpack-plugin');<br>const ScriptExtHtmlWebpackPlugin = require('script-ext-html-webpack-plugin');<br>const METADATA = &#123;<br>  baseUrl: '/',<br>&#125;;<br>module.exports = &#123;<br>  plugins: [<br>    new HtmlWebpackPlugin(&#123;<br>      template: 'src/index.html',<br>      chunks: ['styles', 'runtime', 'polyfills', 'main'],<br>      chunksSortMode: 'manual',<br>      metadata: METADATA,<br>      inject: 'head'<br>    &#125;),<br>    new ScriptExtHtmlWebpackPlugin(&#123;<br>      defaultAttribute: 'defer'<br>    &#125;)<br>  ]<br>&#125;;<br>~~ 由於 Angular 的 zone.js 需要比其他的 js 先載入，所以 polyfills 使用 async，而其他使用 defer這樣配置就可以把 polyfills.js 以外的 script 都加上 defer 屬性。~~把 chunksSortMode 改成 manual, 這樣就會按 chunks 的排序。1<br>2<br>3<br>4<br>5<br>6<br>7<br>...<br>\"scripts\": &#123;<br>    ...<br>    \"build\": \"ng build --prod --extraWebpackConfig webpack.extra.js\",<br>\t...<br>&#125;,<br>...<br>","content":"<p>首先，在 Angular 不 Eject 的情況下，使用其他的 Webpack plugin，這樣需要引入 ngx-build-plus。</p><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install ngx-build-plus</span><br></pre></td></tr></table></figure><p>之後在 angular.json 替換 angular-cli 本來的引導指令</p><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\">  <span class=\"string\">\"architect\"</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">\"build\"</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">\"builder\"</span>: <span class=\"string\">\"ngx-build-plus:build\"</span>,</span><br><span class=\"line\">      ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"string\">\"serve\"</span>: &#123;</span><br><span class=\"line\">       <span class=\"string\">\"builder\"</span>: <span class=\"string\">\"ngx-build-plus:dev-server\"</span>,</span><br><span class=\"line\">       ...</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure><p>別外，在目錄下加入額外的 Webpack 配置文件 <code>webpack.extra.js</code></p><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> HtmlWebpackPlugin = <span class=\"built_in\">require</span>(<span class=\"string\">'html-webpack-plugin'</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> ScriptExtHtmlWebpackPlugin = <span class=\"built_in\">require</span>(<span class=\"string\">'script-ext-html-webpack-plugin'</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> METADATA = &#123;</span><br><span class=\"line\">  baseUrl: <span class=\"string\">'/'</span>,</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"built_in\">module</span>.exports = &#123;</span><br><span class=\"line\">  plugins: [</span><br><span class=\"line\">    <span class=\"keyword\">new</span> HtmlWebpackPlugin(&#123;</span><br><span class=\"line\">      template: <span class=\"string\">'src/index.html'</span>,</span><br><span class=\"line\">      chunks: [<span class=\"string\">'styles'</span>, <span class=\"string\">'runtime'</span>, <span class=\"string\">'polyfills'</span>, <span class=\"string\">'main'</span>],</span><br><span class=\"line\">      chunksSortMode: <span class=\"string\">'manual'</span>,</span><br><span class=\"line\">      metadata: METADATA,</span><br><span class=\"line\">      inject: <span class=\"string\">'head'</span></span><br><span class=\"line\">    &#125;),</span><br><span class=\"line\">    <span class=\"keyword\">new</span> ScriptExtHtmlWebpackPlugin(&#123;</span><br><span class=\"line\">      defaultAttribute: <span class=\"string\">'defer'</span></span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure><p>~~ 由於 Angular 的 <code>zone.js</code> 需要比其他的 js 先載入，所以 polyfills 使用 <code>async</code>，而其他使用 <code>defer</code></p><p>這樣配置就可以把 <code>polyfills.js</code> 以外的 script 都加上 <code>defer</code> 屬性。~~</p><p>把 <code>chunksSortMode</code> 改成 manual, 這樣就會按 <code>chunks</code> 的排序。</p><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\"><span class=\"string\">\"scripts\"</span>: &#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    <span class=\"string\">\"build\"</span>: <span class=\"string\">\"ng build --prod --extraWebpackConfig webpack.extra.js\"</span>,</span><br><span class=\"line\">\t...</span><br><span class=\"line\">&#125;,</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure><p>最後修改 <code>package.json</code> 的 <code>build</code></p><p><a href=\"https://github.com/angular/angular-cli/blob/master/packages/angular_devkit/build_angular/src/angular-cli-files/plugins/index-html-webpack-plugin.ts\" target=\"_blank\" rel=\"noopener\">Angular 官方配置</a></p>","prev":{"title":"PSV變革","link":"/2018/12/17/PSV變革"},"next":{"title":"主題遷移到 Angular 進度","link":"/2018/12/10/主題遷移到-Angular-進度"},"categories":[],"tags":[]}